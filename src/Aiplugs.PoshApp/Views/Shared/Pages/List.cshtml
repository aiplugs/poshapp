<template id="list-page-component">
    <div class="main-content d-flex flex-column">
        <header>
            <v-row class="pl-4 pr-4" style="width: 100%;">
                <v-col cols="12" class="pt-0 pb-0">
                    <parameters-form ref="form" :script="scriptId" :page="page" :page-size="pageSize" :loading="loading=='$run'" :disabled="disabled" v-on:run="run"></parameters-form>
                </v-col>
            </v-row>
            <v-row class="pl-4 pr-4">
                <v-btn text v-for="action in actions" :key="action.name" :loading="loading==action.id" :disabled="disabled" v-on:click="invokeAction(action.id)" retain-focus-on-click>{{action.displayName || action.id}}</v-btn>
            </v-row>
        </header>
        <v-divider></v-divider>
        <div class="flex scroll-content">
            <v-data-table v-model="selected"
                          :headers="headers"
                          :items="list"
                          :page.sync="page"
                          :items-per-page="pageSize"
                          item-key="$clixml"
                          hide-default-footer
                          show-select
                          v-if="list.length > 0">
                <template v-slot:item.$poshapp_action="{ item }">
                    <v-btn icon text v-on:click="openDetail(item)">
                        <v-icon>mdi-fullscreen</v-icon>
                    </v-btn>
                </template>
            </v-data-table>
        </div>
        <div class="ma-auto" style="width: 80%;">
            <v-pagination v-model="page" :length="total" v-if="list.length > 0"></v-pagination>
        </div>
        <transition name="slide-x-reverse-transition">
            <detail-page :script="detailScriptId" :input="detailInput" v-if="detailScriptId" v-on:close="detailScriptId=null"></detail-page>
        </transition>
        <v-btn color="primary" fab dark style="position: absolute; bottom: 8px; right: 8px;" v-on:click="gotoEditor">
            <v-icon>mdi-xml</v-icon>
        </v-btn>
    </div>
</template>
<script type="module">
    import { parsePSDataCollection, createCliXml } from '/js/clixml.js'
    Vue.component('ListPage', {
        template: '#list-page-component',
        data() {
            return {
                selected:[],
                detailScriptId: null,
                detailInput: null,
                page: 1,
                pageSize: 10,
                total: 0,
                list: [],
                headers: [],
                loading: null,
            }
        }, 
        computed: {
            scriptId() {
                return `${this.$route.params.repo}:${this.$route.params.id}`;
            },
            detailId() {
                const { repo, id } = this.$route.params;
                return this.$store.getters['scripts/findDetail'](repo, id);
            },
            actions() {
                const { repo, id } = this.$route.params;
                return this.$store.getters['scripts/findActions'](repo, id);
            },
            disabled() {
                return !!this.loading
            }
        },
        methods: {
            ...Vuex.mapActions('toast', ['toast']),
            ...Vuex.mapMutations('list', ['updateList','replaceData','setDetail']),
            init() {
                this.selected.splice(0);
                this.list.splice(0);
                this.headers.splice(0);
                this.total = 0;
                this.$signalr.on("DefaultResult", json => {
                    this.loading = null;

                    const data = parsePSDataCollection(JSON.parse(json));
                    
                    if (data.length == 0)
                        return;

                    let index = 0;
                    let total = data.length;
                    const pageSize = this.pageSize - 0;

                    if (typeof data[index].value === 'number') {
                        total = data[index].value;
                        index++;
                    }

                    const pageCount = ~~(total / pageSize) + Math.min(1, total % pageSize);

                    const dataset = data.slice(index);

                    const allKeys = Object.keys(dataset.reduce((o,d) => Object.assign(o,d.value),{}));
                    
                    const headers = allKeys.map(key => ({ text:key, value:key, sortable: false }));
                    
                    if (this.detailId) {
                        headers.unshift({text: '', value: '$poshapp_action', width: 64, sortable: false });
                    }

                    this.pageSize = this.$refs.form.getPageSize();
                    this.total = pageCount;
                    this.headers.splice(0, this.headers.length, ...headers);
                    this.list.splice(0, this.list.length, ...dataset.filter(d => typeof d.value == 'object').map(d => {
                        d.value.$clixml = d.clixml;
                        return d.value;
                    }));
                })
                this.$signalr.on("ActionResult", (id, json) => {
                    this.loading = null;
                    const data = JSON.parse(json);
                    this.toast({
                        text: `${id} is succeeded` ,
                        color: "info",
                        top: true,
                        right: true
                    });
                })
                this.$signalr.on('UnitResult', () => {
                    this.loading = null;
                })
            },
            run(value) {
                this.loading = '$run';
                this.$signalr.invoke('Invoke', this.scriptId, value);
            },
            invokeAction(id) {
                this.loading = id;
                this.$signalr.invoke('InvokeAction', id, this.selected.map(item => item.$clixml));
            },
            openDetail(item) {
                const clixml = item.$clixml;
                this.detailInput = clixml;
                this.detailScriptId = this.detailId;
            },
            gotoEditor() {
                if (this.detailId) {
                    const [repo, id] = this.detailId.split(':');
                    this.$router.push(`/scripts/${repo}/${id}`)
                }
                else {
                    this.$router.push(`/scripts/${this.$route.params.repo}/${this.$route.params.id}`)
                }
            }
        },
        mounted() {
            this.init();
        },
        beforeRouteUpdate (to, from, next) {
            this.init();  
            next();
        },
        beforeRouteLeave (to, from , next) {
            this.$signalr.off('DefaultResult');
            this.$signalr.off('ActionResult');
            this.$signalr.off('UnitResult');
            next();
        }
    })
</script>