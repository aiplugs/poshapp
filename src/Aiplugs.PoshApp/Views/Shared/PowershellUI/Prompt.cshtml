<template id="powershell-ui-prompt-component">
    <v-dialog v-model="dialog" max-width="600px" persistent>
        <v-card>
            <v-card-title class="headline" primary-title>
                {{caption}}
            </v-card-title>
            <v-card-text>
                <p style="white-space: pre-wrap">{{message}}</p>
                <v-form ref="form" v-model="valid">
                    <div v-for="(desc, index) in descriptions" :key="index">
                        <v-text-field ref="fields"
                                      :label="desc.label||desc.name"
                                      :data-name="desc.name"
                                      :hint="desc.helpMessage"
                                      :rules="rules(desc)"
                                      :required="desc.isMandatory"
                                      v-model="value[desc.name]"
                                      v-if="textfieldTypes.includes(desc.parameterTypeFullName)">
                            <template v-slot:append v-if="supportFileManager(desc)">
                                <v-icon icon text v-on:click="openDirManager(desc)">mdi-folder-search</v-icon>
                                <v-icon icon text v-on:click="openFileManager(desc)">mdi-file-search</v-icon>
                            </template>
                        </v-text-field>
                        <datetime-field :label="(desc.label||desc.name)"
                                        :hint="desc.helpMessage"
                                        :rules="rules(desc)"
                                        :required="desc.isMandatory"
                                        v-model="value[desc.name]"
                                        v-if="desc.parameterTypeFullName == 'System.DateTime'">
                        </datetime-field>
                    </div>
                </v-form>
            </v-card-text>
            <v-divider></v-divider>
            <v-card-actions>
                <v-spacer></v-spacer>
                <v-btn text :disabled="!valid" v-on:click="handlePrompt">OK</v-btn>
            </v-card-actions>
        </v-card>
    </v-dialog>
</template>
<script type="module">
    import {createCliXml} from '/js/clixml.js'
    
    Vue.component('powershelluiprompt', {
        template: '#powershell-ui-prompt-component',
        data() {
            return {
                dialog: false,
                caption: null,
                message: null,
                descriptions: [],
                valid: false,
                value: {},
                menu: {},
                textfieldTypes: ['System.String','System.Int32','System.Int64','System.Float','System.Double','System.Decimal']
            }
        },
        methods: {
            supportFileManager(desc) {
                return desc.parameterTypeFullName === 'System.String' && desc.name.toLowerCase().endsWith('path');
            },
            rules(desc) {
                const result = [];
                const label = desc.label||desc.name;

                if (desc.isMandatory)
                    result.push(v => !!v || `${label} is required`);

                if (desc.parameterTypeFullName == 'System.Int32'
                 || desc.parameterTypeFullName == 'System.Int64')
                    result.push(v => !isNaN(parseInt(v)) || `${label} need integer value`)

                if (desc.parameterTypeFullName == 'System.Float'
                 || desc.parameterTypeFullName == 'System.Double'
                 || desc.parameterTypeFullName == 'System.Decimal')
                    result.push(v => !isNaN(parseFloat(v)) || `${label} need number value`)

                return result;
            },
            handlePrompt() {
                const model = {};
                for (let desc of this.descriptions) {
                    let value = null;
                    if (desc.parameterTypeFullName == 'System.DateTime') {
                        value = new Date(this.value[desc.name]).toJSON();
                    }
                    else {
                       value = this.value[desc.name];
                    }
                    model[desc.name] = createCliXml(desc.parameterTypeFullName, value);
                }
                this.$signalr.invoke('Prompt', model);
                this.dialog = false;
            },
            openDirManager(desc) {
                if (desc.parameterTypeFullName.endsWith('[]') || desc.parameterTypeFullName.startsWith('IEnumerable')) {
                    ipcRenderer.send('select-directories', desc.name);
                }
                else {
                    ipcRenderer.send('select-directory', desc.name);
                }
            }, 
            openFileManager(desc) {
                if (desc.parameterTypeFullName.endsWith('[]') || desc.parameterTypeFullName.startsWith('IEnumerable')) {
                    ipcRenderer.send('select-files', desc.name);
                }
                else {
                    ipcRenderer.send('select-file', desc.name);
                }
            }
        },
        mounted() {
            this.$signalr.on('Prompt', (caption, message, descriptions) => {
                this.caption = caption;
                this.message = message;
                this.descriptions.splice(0, this.descriptions.length, ...descriptions);
                for (let desc of this.descriptions) {
                    this.$set(this.value, desc.name, desc.defaultValue);
                }
                this.dialog = true;
                this.$refs.form.reset();
            })
            ipcRenderer.on('select-directories-reply', (sender, path, name) => {
                this.value[name] = path;
            });
            ipcRenderer.on('select-director-reply', (sender, path, name) => {
                this.value[name] = path;
            });
            ipcRenderer.on('select-files-reply', (sender, path, name) => {
                this.value[name] = path;
            });
            ipcRenderer.on('select-file-reply', (sender, path, name) => {
                this.value[name] = path;
            });
        }
    })
</script>